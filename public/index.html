<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EdVenture ‚Ä¢ Educational Mode</title>

<!-- MathJax -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- Inter -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

<style>
/* ---------- App Shell (Sidebar + Topbar) ---------- */
:root{
  --navy:#0C2A5B;
  --navy-2:#0A1E42;
  --page:#F5F7FD;
  --ink:#0F172A;
  --muted:#64748B;
  --outline:#E7ECF5;
  --card:#FFFFFF;
  --radius:18px;
  --radius-sm:12px;
  --shadow-lg:0 18px 40px rgba(16,24,40,.12);
  --shadow-md:0 10px 26px rgba(16,24,40,.08);
}

*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--page);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

/* Layout */
.app{display:grid;grid-template-columns:220px 1fr;height:100%}

/* Sidebar */
.sidebar{
  background:var(--navy);
  color:#E6ECFF;
  padding:24px 0;
  display:flex;flex-direction:column;align-items:stretch;gap:12px;
}
.brand{display:flex;align-items:center;gap:10px;padding:0 16px}
.brand-badge{width:28px;height:28px;border-radius:6px;background:rgba(255,255,255,.15);display:grid;place-items:center;font-weight:800;color:#fff}
.brand-title{color:#E6EEFF;font-weight:900}

.menu{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.menu a{color:#E6ECFF;text-decoration:none}
.item{height:44px;border-radius:14px;display:flex;align-items:center;gap:10px;padding:0 12px;margin:0 16px}
.item:hover{background:rgba(255,255,255,.10)}
.item.active{background:#fff;color:var(--navy)}
.dot{width:8px;height:8px;border-radius:999px;background:#E6ECFF;opacity:.7}
.item.active .dot{background:var(--navy)}

.quiz-card{
  margin-top:auto;margin-left:auto;margin-right:auto;margin-bottom:20px;
  width:132px;background:#fff;border-radius:18px;padding:14px;display:flex;flex-direction:column;align-items:center;gap:8px;
  box-shadow:0 10px 22px rgba(12,42,91,.18);
}
.plus{width:56px;height:56px;border-radius:12px;background:#EEF2FF;display:grid;place-items:center;color:var(--navy);font-size:28px;font-weight:900}

/* Main area */
.main{display:flex;flex-direction:column;min-width:0}

/* Top bar */
.topbar{
  margin:16px 24px 0; background:#fff; border-radius:16px; height:56px;
  display:flex;align-items:center;gap:12px;padding:0 12px; box-shadow:0 8px 22px rgba(10,30,66,.06);
}
.greet{font-weight:800;color:var(--navy);margin-right:8px}
.search{flex:1;display:flex;align-items:center;background:#F3F5FA;border-radius:10px;height:36px;padding:0 12px;gap:8px}
.search input{border:none;outline:none;background:transparent;width:100%;color:var(--ink)}
.right{display:flex;align-items:center;gap:12px}
.bell{position:relative;padding:6px}
.bell .ping{position:absolute;top:4px;right:4px;width:8px;height:8px;border-radius:999px;background:#3B82F6}
.avatar{display:flex;align-items:center;gap:8px;background:#F3F5FA;border-radius:999px;padding:0 8px;height:36px}
.avatar img{width:24px;height:24px;border-radius:999px}

/* Content area container */
.content{flex:1;min-height:0;overflow:auto;padding:24px}

/* ---------- Camera UI ---------- */
.container{max-width:1220px;margin:0 auto}
.grid{display:grid;gap:18px;grid-template-columns:1.04fr .96fr;align-items:start}
@media (max-width:992px){.grid{grid-template-columns:1fr}}

.card{
  background:#fff;border:1px solid var(--outline);border-radius:var(--radius);
  box-shadow:var(--shadow-md);overflow:hidden
}
.card .header{padding:14px 16px;border-bottom:1px solid var(--outline);background:linear-gradient(180deg,#fbfdff,#f7faff)}
.card .header span{font-weight:800}
.card .body{padding:16px}

.btn{appearance:none;border:none;cursor:pointer;border-radius:14px;padding:12px 18px;font-weight:800;letter-spacing:.01em;position:relative}
.btn-primary{color:#fff;background:linear-gradient(135deg,#0D2A57,#1A3A7A);box-shadow:0 10px 22px rgba(13,42,87,.30)}
.btn-outline{background:#fff;border:1px solid var(--outline);color:var(--ink)}
.btn-chip{background:#fff;border:1px solid var(--outline);border-radius:999px;padding:8px 12px;font-weight:700}

.camera-wrap{position:relative;border-radius:16px;overflow:hidden;border:1px solid var(--outline);background:#000}
video,canvas{display:block;width:100%}
.guide{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center}
.guide .frame{width:78%;height:68%;border:3px dashed rgba(255,255,255,.66);border-radius:14px;box-shadow:0 0 0 9999px rgba(0,0,0,.18) inset}

.toggles{display:flex;gap:10px;flex-wrap:wrap;color:#64748B;font-size:13px}
.toggles label{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--outline);padding:8px 12px;border-radius:999px}
.toggles input{transform:scale(1.2)}

.fab{position:sticky;bottom:-1px;margin-top:12px;padding:10px;display:flex;gap:10px;align-items:center;justify-content:flex-start;background:linear-gradient(180deg, rgba(246,248,252,0), rgba(246,248,252,1) 35%);border-radius:0 0 var(--radius) var(--radius)}
.subtitle{font-size:13px;color:#64748B}

.pill{display:block;background:#F8FAFF;border:1px solid var(--outline);padding:12px 14px;border-radius:12px;min-height:44px}
.pre{white-space:pre-wrap;word-break:break-word}

.skeleton{position:relative;overflow:hidden;background:#eef2f8;border-radius:12px;height:48px}
.skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg, transparent, rgba(255,255,255,.65), transparent);animation:shimmer 1.35s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

.history{display:flex;flex-direction:column;gap:10px}
.history-item{border:1px solid var(--outline);border-radius:12px;padding:10px;background:#fff}
.history-head{display:flex;justify-content:space-between;gap:8px;font-size:12px;color:#64748B}
.history-actions{display:flex;gap:6px}

.toast{position:fixed;right:18px;bottom:18px;z-index:90;display:flex;flex-direction:column;gap:10px}
.toast>div{background:#101828;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 26px rgba(16,24,40,.28);opacity:.98;font-weight:600;font-size:13px;transform:translateY(8px);animation:toast-in .22s ease forwards}
@keyframes toast-in{to{transform:translateY(0)}}

.modal{position:fixed;inset:0;display:none;place-items:center;z-index:80;background:rgba(10,15,25,.38)}
.modal.open{display:grid}
.modal-card{width:min(560px,92vw);background:#fff;border-radius:18px;box-shadow:var(--shadow-lg);border:1px solid var(--outline);padding:18px}
.modal-card h3{margin:0 0 8px}
.modal-card p{margin:6px 0;color:#475569}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

.hide{display:none!important}
</style>
</head>
<body>

<div class="app">
  <!-- ========== SIDEBAR ========== -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-badge">‚ú¶</div>
      <div class="brand-title">EdVenture</div>
    </div>

    <nav class="menu" aria-label="Sidebar">
      <a class="item" href="#"><span class="dot"></span><span>Dashboard</span></a>
      <a class="item active" href="#"><span class="dot"></span><span>Educational Mode</span></a>
      <a class="item" href="#"><span class="dot"></span><span>Games Mode</span></a>
      <a class="item" href="#"><span class="dot"></span><span>Leaderboard</span></a>
      <a class="item" href="#"><span class="dot"></span><span>Settings</span></a>
    </nav>

    <div class="quiz-card">
      <div class="plus">+</div>
      <div style="color:var(--navy);font-weight:900">Join Quiz</div>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <main class="main">
    <!-- Top bar -->
    <div class="topbar" role="banner">
      <div class="greet">Good morning, Salman</div>
      <div class="search">
        <span style="color:#9CA3AF">üîç</span>
        <input type="text" placeholder="Search" />
      </div>
      <div class="right">
        <div class="bell" title="Notifications">üîî<span class="ping"></span></div>
        <div class="avatar">
          <img src="https://github.com/MjdMAlamri/Images/raw/refs/heads/main/avatarimg" alt="avatar" />
          <span style="color:#9CA3AF">‚ñæ</span>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="container">
        <!-- Work area ONLY (no hero) -->
        <section class="grid" aria-label="work area">
          <!-- Camera panel -->
          <article class="card" aria-label="camera panel">
            <div class="header">
              <span>Live Camera</span>
              <button id="btn-restart" class="btn-chip" title="Restart camera (R)">Restart</button>
            </div>
            <div class="body">
              <div class="camera-wrap" id="camFrame">
                <video id="video" autoplay playsinline muted aria-label="camera preview"></video>
                <div class="guide" aria-hidden="true"><div class="frame"></div></div>
                <canvas id="canvas" style="display:none;"></canvas>
              </div>

              <div class="toggles" style="margin-top:12px">
                <label><input id="toggle-auto" type="checkbox"> Auto-capture (every 4s)</label>
                <label><input id="toggle-crop" type="checkbox" checked> Tight crop (center)</label>
                <button id="btn-help" class="btn-chip">Tips</button>
              </div>

              <!-- Sticky action bar -->
              <div class="fab">
                <button id="btn-capture" class="btn btn-primary" disabled>Capture & Explain (C)</button>
                <button id="btn-stop" class="btn btn-outline">Stop Camera (S)</button>
                <div id="status" class="subtitle" style="margin-left:auto;">Starting camera‚Ä¶</div>
              </div>
            </div>
          </article>

          <!-- Results + History stack -->
          <div class="stack" style="display:flex;flex-direction:column;gap:18px" aria-live="polite">
            <!-- OCR -->
            <article class="card">
              <div class="header">
                <span>OCR Output</span>
                <button id="btn-copy-ocr" class="btn-chip">Copy</button>
              </div>
              <div class="body">
                <div id="ocrSkeleton" class="skeleton hide"></div>
                <div class="pill"><pre id="ocrText" class="pre">-</pre></div>
              </div>
            </article>

            <!-- Explanation -->
            <article class="card">
              <div class="header">
                <span>Explanation</span>
                <div style="display:flex;gap:8px">
                  <button id="btn-step" class="btn-chip">Step-by-step</button>
                  <button id="btn-copy-expl" class="btn-chip">Copy</button>
                  <button id="btn-share" class="btn-chip">Share</button>
                  <button id="btn-pdf" class="btn-chip">Save PDF</button>
                </div>
              </div>
              <div class="body">
                <div id="expSkeleton" class="skeleton hide" style="height:96px"></div>
                <div class="pill" style="padding:14px">
                  <div id="explainOut">-</div>
                  <details id="stepsAcc" class="hide" style="margin-top:10px">
                    <summary style="cursor:pointer;font-weight:800">Reveal steps</summary>
                    <div id="stepsBody" style="margin-top:8px"></div>
                  </details>
                </div>
              </div>
            </article>

            <!-- History -->
            <article class="card">
              <div class="header">
                <span>Session History</span>
                <button id="btn-clear-history" class="btn-chip">Clear</button>
              </div>
              <div class="body">
                <div id="history" class="history">
                  <div id="history-empty" class="history-item">No previous captures yet.</div>
                </div>
              </div>
            </article>
          </div>
        </section>
      </div>
    </div>
  </main>
</div>

<!-- Hidden hero buttons (keep logic intact) -->
<button id="btn-capture-hero" class="hide">Capture</button>
<button id="btn-stop-hero" class="hide">Stop</button>

<!-- Tips Modal -->
<div id="tips" class="modal" role="dialog" aria-modal="true" aria-labelledby="tips-title">
  <div class="modal-card">
    <h3 id="tips-title">Better Results ‚Äî Quick Tips</h3>
    <p>‚Ä¢ Place the expression inside the dashed frame. Avoid glare and shadows.</p>
    <p>‚Ä¢ Use <b>Tight crop</b> to focus the math region and remove background noise.</p>
    <p>‚Ä¢ For long derivations, enable <b>Auto-capture</b> and move the paper slowly.</p>
    <div class="modal-actions">
      <button id="tips-close" class="btn btn-outline">Close</button>
      <button id="tips-ok" class="btn btn-primary">Got it</button>
    </div>
  </div>
</div>

<!-- Toasts -->
<div id="toasts" class="toast" aria-live="polite" aria-atomic="true"></div>

<script>
/* ====== CAMERA & UI LOGIC ====== */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ocrTextEl = document.getElementById("ocrText");
const explainOut = document.getElementById("explainOut");
const statusEl = document.getElementById("status");
const ocrSkel = document.getElementById("ocrSkeleton");
const expSkel = document.getElementById("expSkeleton");
const historyEl = document.getElementById("history");
const historyEmpty = document.getElementById("history-empty");
const stepsAcc = document.getElementById("stepsAcc");
const stepsBody = document.getElementById("stepsBody");

const btnCapture = document.getElementById("btn-capture");
const btnStop = document.getElementById("btn-stop");
const btnRestart = document.getElementById("btn-restart");
const btnStep = document.getElementById("btn-step");
const btnCopyOCR = document.getElementById("btn-copy-ocr");
const btnCopyExp = document.getElementById("btn-copy-expl");
const btnShare = document.getElementById("btn-share");
const btnPDF = document.getElementById("btn-pdf");
const btnClearHist = document.getElementById("btn-clear-history");
const btnCaptureHero = document.getElementById("btn-capture-hero");
const btnStopHero = document.getElementById("btn-stop-hero");
const toggleAuto = document.getElementById("toggle-auto");
const toggleCrop = document.getElementById("toggle-crop");

const tips = document.getElementById("tips");
document.getElementById("btn-help").onclick = ()=> tips.classList.add("open");
document.getElementById("tips-close").onclick = ()=> tips.classList.remove("open");
document.getElementById("tips-ok").onclick = ()=> tips.classList.remove("open");

let stream=null, autoTimer=null;
function toast(msg){
  const host = document.getElementById("toasts");
  const n = document.createElement("div");
  n.textContent = msg;
  host.appendChild(n);
  setTimeout(()=>{ n.style.opacity=.0; setTimeout(()=>host.removeChild(n),220); }, 1800);
}
function status(msg, isErr=false){
  statusEl.textContent = msg;
  statusEl.style.color = isErr ? "#b91c1c" : "#64748B";
}
function secureOK(){
  const h=location.hostname, p=location.protocol;
  return p==="https:" || h==="localhost" || h==="127.0.0.1" || h==="[::1]";
}
function copy(text){ if(!text) return; navigator.clipboard?.writeText(text).then(()=>toast("Copied")); }
async function share(text){
  if (navigator.share){ try{ await navigator.share({title:"EdVenture Result", text}); toast("Shared"); }catch(e){} }
  else { copy(text); }
}
function openPDF(ocr, html){
  const w=window.open("","_blank");
  w.document.write(`<html><head><title>EdVenture ‚Äî Solution</title>
  <style>body{font-family:Inter,system-ui,sans-serif;padding:24px} h2{margin:.2rem 0} pre{white-space:pre-wrap}</style>
  </head><body><h2>OCR</h2><pre>${ocr.replaceAll("<","&lt;")}</pre><h2>Explanation</h2><div>${html}</div></body></html>`);
  w.document.close(); w.focus(); setTimeout(()=>w.print(), 300);
}

/* History */
function saveHistory(text, explanation){
  const list = JSON.parse(localStorage.getItem("edv_hist")||"[]");
  list.unshift({ ts:Date.now(), text, explanation });
  while(list.length>6) list.pop();
  localStorage.setItem("edv_hist", JSON.stringify(list));
  renderHistory();
}
function renderHistory(){
  const list = JSON.parse(localStorage.getItem("edv_hist")||"[]");
  historyEl.innerHTML = "";
  if (!list.length){
    historyEl.appendChild(historyEmpty);
    historyEmpty.classList.remove("hide"); return;
  }
  list.forEach((it, idx)=>{
    const d=new Date(it.ts);
    const el=document.createElement("div");
    el.className="history-item";
    el.innerHTML=`
      <div class="history-head"><span>${d.toLocaleString()}</span>
        <div class="history-actions">
          <button class="btn-chip hist-restore" data-i="${idx}">Restore</button>
          <button class="btn-chip hist-copy" data-i="${idx}">Copy</button>
        </div>
      </div>
      <div style="margin-top:6px;color:#0f172a;font-weight:600">OCR</div>
      <div style="font-size:13px;color:#475569">${it.text||"-"}</div>
    `;
    historyEl.appendChild(el);
  });
  historyEl.querySelectorAll(".hist-restore").forEach(b=>{
    b.onclick=()=>{
      const list=JSON.parse(localStorage.getItem("edv_hist")||"[]");
      const i=+b.dataset.i, it=list[i]; if(!it) return;
      ocrTextEl.textContent=it.text||"-";
      explainOut.innerHTML=it.explanation||"-";
      if (window.MathJax?.typesetPromise) MathJax.typesetPromise([explainOut]);
      toast("Restored from history");
    };
  });
  historyEl.querySelectorAll(".hist-copy").forEach(b=>{
    b.onclick=()=>{
      const list=JSON.parse(localStorage.getItem("edv_hist")||"[]");
      const i=+b.dataset.i, it=list[i]; if(!it) return;
      copy(`OCR:\n${it.text}\n\nExplanation:\n${it.explanation.replace(/<[^>]*>/g,"")}`);
    };
  });
}

/* Camera shim */
(function shim(){
  if(!navigator.mediaDevices) navigator.mediaDevices={};
  if(!navigator.mediaDevices.getUserMedia){
    const gum=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;
    if(gum) navigator.mediaDevices.getUserMedia=(c)=>new Promise((res,rej)=>gum.call(navigator,c,res,rej));
  }
})();

async function startCamera(){
  if(!secureOK()) return status("Open on https:// or http://localhost:3000", true);
  if(!navigator.mediaDevices?.getUserMedia) return status("Camera API unavailable", true);
  try{
    status("Requesting camera permission‚Ä¶");
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ width:{ideal:1280}, height:{ideal:720}, facingMode:{ideal:"environment"} },
      audio:false
    });
    video.srcObject = stream;
    await new Promise(r=>{ if(video.readyState>=1) return r(); video.onloadedmetadata=()=>r(); });
    await video.play();
    btnCapture.disabled=false;
    status("Camera ready. Tip: fit math inside the frame.");
    if(toggleAuto.checked && !autoTimer) autoTimer=setInterval(()=>btnCapture.click(), 4000);
  }catch(e){ status("Could not access camera: "+(e?.message||e), true); }
}
function stopCamera(){
  if(autoTimer){clearInterval(autoTimer);autoTimer=null;}
  if(stream){ for(const t of stream.getTracks()) t.stop(); stream=null; }
  video.srcObject=null; btnCapture.disabled=true; status("Camera stopped.");
}

/* Wiring */
window.addEventListener("load", ()=>{ startCamera(); renderHistory(); });

btnStop.onclick = stopCamera;
btnRestart.onclick = ()=>{ stopCamera(); startCamera(); };
btnCaptureHero.onclick = ()=>btnCapture.click();
btnStopHero.onclick    = ()=>btnStop.click();

btnCopyOCR.onclick = ()=>copy(ocrTextEl.innerText.trim());
btnCopyExp.onclick = ()=>copy(explainOut.innerText.trim());
btnShare.onclick   = ()=>share(`OCR:\n${ocrTextEl.innerText.trim()}\n\nExplanation:\n${explainOut.innerText.trim()}`);
btnPDF.onclick     = ()=>openPDF(ocrTextEl.innerText.trim(), explainOut.innerHTML);
btnClearHist.onclick = ()=>{ localStorage.removeItem("edv_hist"); renderHistory(); toast("History cleared"); };

toggleAuto.onchange = ()=>{
  if(toggleAuto.checked && !autoTimer) autoTimer=setInterval(()=>btnCapture.click(), 4000);
  else if(!toggleAuto.checked && autoTimer){clearInterval(autoTimer);autoTimer=null;}
};

/* Shortcuts */
window.addEventListener("keydown",(e)=>{
  if(e.key.toLowerCase()==="c") btnCapture.click();
  if(e.key.toLowerCase()==="s") btnStop.click();
  if(e.key.toLowerCase()==="r") btnRestart.click();
  if((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key.toLowerCase()==="c") btnCopyExp.click();
});

/* Capture pipeline */
function showSkeletons(show){
  [ocrSkel, expSkel].forEach(s=>s.classList.toggle("hide", !show));
}
btnCapture.onclick = async ()=>{
  if(!stream) return status("Camera is not running.", true);
  const vw=video.videoWidth||1280, vh=video.videoHeight||720;
  if(!vw||!vh) return status("Camera not ready", true);

  let sx=0, sy=0, sw=vw, sh=vh;
  if(toggleCrop.checked){
    const scale=.80; sw=Math.floor(vw*scale); sh=Math.floor(vh*scale);
    sx=Math.floor((vw-sw)/2); sy=Math.floor((vh-sh)/2);
  }
  canvas.width=sw; canvas.height=sh;
  const ctx=canvas.getContext("2d"); ctx.drawImage(video, sx,sy,sw,sh, 0,0,sw,sh);
  const dataUrl=canvas.toDataURL("image/jpeg", .9);

  showSkeletons(true);
  ocrTextEl.textContent="-";
  explainOut.innerHTML="-";
  stepsAcc.classList.add("hide");
  status("Analyzing‚Ä¶ (OCR + Explain)");
  btnCapture.disabled=true;

  const r=await fetch("/api/pipeline",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ imageDataUrl:dataUrl }) });
  const data=await r.json().catch(()=>({}));
  showSkeletons(false);

  if(!r.ok){ status("Pipeline failed. "+(data?.error||r.statusText), true); btnCapture.disabled=false; return; }

  ocrTextEl.textContent=data.text||"-";
  explainOut.innerHTML=data.explanation||"-";

  const raw=(data.explanation||"");
  const chunks = raw.split(/(?:##\s*Step.*?:|<br>|\\n)/i).map(s=>s.trim()).filter(Boolean);
  if(chunks.length>1){
    stepsBody.innerHTML="";
    chunks.forEach((c,i)=>{
      const p=document.createElement("p"); p.style.margin="8px 0"; p.innerHTML = (i?`<b>Step ${i}.</b> `:"")+c;
      stepsBody.appendChild(p);
    });
    stepsAcc.classList.remove("hide");
  }

  if(window.MathJax?.typesetPromise) await MathJax.typesetPromise([explainOut, stepsBody]);
  saveHistory(ocrTextEl.textContent, explainOut.innerHTML);
  status("Done.");
  btnCapture.disabled=false;
};
</script>
</body>
</html>
